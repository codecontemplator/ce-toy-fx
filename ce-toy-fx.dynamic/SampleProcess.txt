using ce_toy_fx.sample.VariableTypes;
using System;
using System.Linq;

namespace ce_toy_fx.sample
{
    using RuleDef = RuleExprAst<Unit, RuleExprContext<Unit>>;

    namespace VariableTypes
    {
        public enum Roles
        {
            Primary, Other
        }

        public class Address
        {
            public string Street { get; init; }
            public string PostalCode { get; init; }
            public bool IsValid => !string.IsNullOrEmpty(Street);
        }
    }

    public static class Variables
    {
        public class CreditADef : Variable<int>
        {
            private CreditADef() { }
            public override string Name => nameof(CreditA);
            public static CreditADef Instance { get; } = new CreditADef();
        }

        public class CreditBDef : Variable<int>
        {
            private CreditBDef() { }
            public override string Name => nameof(CreditB);
            public static CreditBDef Instance { get; } = new CreditBDef();
        }

        public class SalaryDef : Variable<int>
        {
            private SalaryDef() { }
            public override string Name => nameof(Salary);
            public static SalaryDef Instance { get; } = new SalaryDef();
        }

        public class RoleDef : Variable<VariableTypes.Roles>
        {
            private RoleDef() { }
            public override string Name => nameof(Role);
            public static RoleDef Instance { get; } = new RoleDef();
        }

        public class AddressDef : Variable<VariableTypes.Address>
        {
            private AddressDef() { }
            public override string Name => nameof(Address);
            public static AddressDef Instance { get; } = new AddressDef();
        }

        public class CreditScoreDef : Variable<double>
        {
            private CreditScoreDef() { }
            public override string Name => nameof(CreditScore);
            public static CreditScoreDef Instance { get; } = new CreditScoreDef();
        }

        public class AgeDef : Variable<int>
        {
            private AgeDef() { }
            public override string Name => nameof(Age);
            public static AgeDef Instance { get; } = new AgeDef();
        }

        public class DeceasedDef : Variable<bool>
        {
            private DeceasedDef() { }
            public override string Name => nameof(Deceased);
            public static DeceasedDef Instance { get; } = new DeceasedDef();
        }

        public class FlagsDef : Variable<int>
        {
            private FlagsDef() { }
            public override string Name => nameof(Flags);
            public static FlagsDef Instance { get; } = new FlagsDef();
        }

        public static CreditADef CreditA => CreditADef.Instance;
        public static CreditBDef CreditB => CreditBDef.Instance;
        public static SalaryDef Salary => SalaryDef.Instance;
        public static RoleDef Role => RoleDef.Instance;
        public static AddressDef Address => AddressDef.Instance;
        public static CreditScoreDef CreditScore => CreditScoreDef.Instance;
        public static AgeDef Age => AgeDef.Instance;
        public static DeceasedDef Deceased => DeceasedDef.Instance;
        public static FlagsDef Flags => FlagsDef.Instance;
    }

    class SampleProcess
    {
        private static readonly PassUnit passed = PassUnit.Value;
        private static readonly FailUnit rejected = FailUnit.Value;

        private static RuleDef AbsoluteMaxAmount(int amountLimit)
        {
            return
                (
                    from amount in Dsl.GetAmount<Unit>()
                    select new Amount(Math.Min(amount, amountLimit))
                ).Apply();
        }

        private static RuleDef MaxTotalDebt(double debtLimit)
        {
            return
               (
                    from creditA in Variables.CreditA.Value
                    from creditB in Variables.CreditB.Value
                    let totalCredit = creditA + creditB
                    where totalCredit < debtLimit
                    select passed
               ).Lift().Apply();
        }

        private static RuleDef MinTotalSalary(int salaryLimit)
        {
            return
                (
                    from salaries in Variables.Salary.Values
                    where salaries.Sum() > salaryLimit
                    select passed
                ).Apply();
        }

        private static RuleDef PrimaryApplicantMustHaveAddress()
        {
            return
                (
                    from role in Variables.Role.Value
                    where role == Roles.Primary
                    from address in Variables.Address.Value
                    where !address.IsValid
                    select rejected
               ).Lift().Apply();
        }

        private static RuleDef CreditScoreUnderLimit(double limit)
        {
            return
               (
                    from creditScore in Variables.CreditScore.Value
                    where creditScore < limit
                    select passed
               ).Lift().Apply();
        }

        private static RuleDef Policies(int minAge, int maxAge, int maxFlags)
        {
            return
                new RuleDef[]
                {
                    Variables.Age.Value.RejectIf     (age => age < minAge || age > maxAge, $"Age must be greater than {minAge} and less than {maxAge}"),
                    Variables.Deceased.Value.RejectIf(deceased => deceased,                $"Must be alive"),
                    Variables.Flags.Value.RejectIf   (flags => flags >= 2,                 $"Flags must be less than {maxFlags}")
                }.Join();
        }

        public static RuleDef CaseRule()
        {
            return
                Variables.Age.Value.Case(
                        (age => age < 18,              (from salary in Variables.Salary.Value where salary > 10 select passed).LogContext("Age < 18")),
                        (age => age >= 18 && age < 65, (from salary in Variables.Salary.Value where salary > 20 select passed).LogContext("Age >= 18 && Age < 65")),
                        (age => age >= 65,             (from salary in Variables.Salary.Value where salary > 15 select passed).LogContext("Age >= 65"))
                    ).Lift().Apply();
        }

        public static Process GetProcess()
        {
            return
                new[]
                {
                    Policies(18, 100, 2).LogContext("Policies"),
                    AbsoluteMaxAmount(100).LogContext("AbsoluteMaxAmount"),
                    MaxTotalDebt(50).LogContext("MaxTotalDebt"),
                    PrimaryApplicantMustHaveAddress().LogContext("PrimaryApplicantMustHaveAddress"),
                    CreditScoreUnderLimit(0.9).LogContext("CreditScoreUnderLimit"),
                    MinTotalSalary(50).LogContext("MinTotalSalary"),
                    CaseRule().LogContext("CaseRule"),
                }.CompileToProcess("Sample process");
        }
    }
}
